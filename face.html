<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="face.css">

    <title>Face Gallery</title>
</head>

<body>

    <div id="sticky-header">
        <div id="headline">
            <a href="index.html">
                <img src="assets/logo.svg" alt="Headline" class="headline-img">
            </a>
        </div>
    </div>

    <div class="frame container mx-auto px-4 py-6">
        <a href="gallery.html" class="back-btn">
            Back to gallery
        </a>
        <h2>Reveal a face</h2>
        <p class="subtitle">Click on a silhouette to uncover an imagined face of someone history left unidentified.</p>
        <button id="randomize-btn" class="randomize-btn">Randomize</button>
        <div class="portraits">
            <div id="face-gallery">

                <!-- Random images will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="image-overlay" class="overlay">
        <button class="overlay-close" onclick="closeOverlay()">Close</button>
        <div class="overlay-content">
            <div class="overlay-left">
                <img id="overlay-image" src="" alt="">
                <div id="overlay-caption" class="overlay-caption"></div>
            </div>
            <div class="overlay-right">
                <div id="placeholder-image-area" class="placeholder-area">
                    <img id="placeholder-image" src="" alt="Generated silhouette" style="display: none;">
                </div>
                <button id="generate-btn" class="generate-btn">Reveal a face</button>
                <p>This is generated by AI</p>
            </div>
        </div>
    </div>

    <script>

        let isClientReady = false;
        let mClient = null;

        async function preload() {
            try {
                let Gradio = await import("https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js");
                mClient = await Gradio.Client.connect("arman396/Smithsonian-Unidentified");
                isClientReady = true;
                console.log("Gradio client loaded", Gradio, mClient);

                // Enable snap button if camera is already open
                // if (currentStream && snapBtn) snapBtn.disabled = false;
            } catch (err) {
                console.error("Failed to load Gradio client:", err);
                showError(err);
            }
        }

        async function runFilter(imgBlob) {
            if (!mClient || !isClientReady) {
                throw new Error('Silhouette filter is still loading, please wait...');
            }

            let input = {
                input_image: imgBlob,
            }

            let filterRes = await mClient.predict("/predict", input);
            return filterRes.data[0].url;
        }
        preload();


        (function () {
            const DATA_URL = "data/dataset.json";
            const gallery = document.getElementById("face-gallery");
            const randomizeBtn = document.getElementById("randomize-btn");
            let currentRecords = [];
            let allData = null; // Store the dataset globally
            function field(r, k) {
                return r && r[k] ? String(r[k]) : "";
            }

            function haystack(r) {
                return (
                    field(r, "title") +
                    " " +
                    field(r, "topic") +
                    " " +
                    field(r, "indexed_topics") +
                    " " +
                    field(r, "indexed_names") +
                    " " +
                    field(r, "indexed_object_types") +
                    " " +
                    field(r, "physicalDescription") +
                    " " +
                    field(r, "objectType")
                ).toLowerCase();
            }

            // Fisher-Yates shuffle to get random items
            function getRandomItems(array, count) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled.slice(0, count);
            }

            function openOverlay(filename) {
                const record = currentRecords.find(r => r.filename === filename);
                if (!record) return;

                const overlay = document.getElementById('image-overlay');
                const overlayImage = document.getElementById('overlay-image');
                const overlayCaption = document.getElementById('overlay-caption');

                // Set the full-size image
                overlayImage.src = record.thumbnail;
                overlayImage.alt = field(record, 'title') || field(record, 'name') || 'silhouette';



                // const url = await runFilter(overlayImage.src);

                // Set caption with metadata
                const captionHTML = `
                ${field(record, 'title') || field(record, 'name') || 'Untitled'}<br>
                ${field(record, 'date') || field(record, 'indexed_dates') || ''}<br>
                ${field(record, 'places') || field(record, 'indexed_places') || ''}
            `;
                overlayCaption.innerHTML = captionHTML;

                overlay.classList.add('active');
            }

            window.closeOverlay = function () {
                const overlay = document.getElementById('image-overlay');
                overlay.classList.remove('active');
                // Clear placeholder image
                const placeholderImage = document.getElementById('placeholder-image');
                placeholderImage.src = '';
                placeholderImage.style.display = 'none';
                // Reset generate button
                const generateBtn = document.getElementById('generate-btn');
                generateBtn.textContent = 'Reveal a face';
                generateBtn.disabled = false;
            };

            function onVisualGenerated() {
                const overlayImage = document.getElementById('overlay-image');
                const generateBtn = document.getElementById('generate-btn');
                generateBtn.textContent = 'Generating...';
                generateBtn.disabled = true;
                fetch(overlayImage.src)
                    .then(response => response.blob())
                    .then(async (blob) => {
                        const url = await runFilter(blob);
                        const placeholderImage = document.getElementById('placeholder-image');
                        placeholderImage.src = url;
                        placeholderImage.style.display = 'block';
                    });
            }
            document.getElementById('generate-btn').addEventListener('click', onVisualGenerated);
            // Close overlay on background click
            document.getElementById('image-overlay').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeOverlay();
                }
            });

            // Close overlay on Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeOverlay();
                }
            });

            function loadRandomGallery(data) {
                if (!gallery) return;

                // Filter for silhouettes only
                const silhouettes = data.filter((r) => haystack(r).includes("silhouette"));

                // Filter for unidentified only
                const unidentified = silhouettes.filter((r) => {
                    const title = field(r, "title").trim().toLowerCase();
                    return title.startsWith("unidentified");
                });

                // Get 20 random items from unidentified
                const randomSelection = getRandomItems(unidentified, 20);
                currentRecords = randomSelection;

                // Render the gallery
                const html = randomSelection
                    .map((r) => {
                        const alt = field(r, "title") || field(r, "name") || "silhouette";
                        const fn = field(r, "filename");
                        return `
            <div class="gallery-item" onclick="openOverlay('${fn}')">
                <img class="gallery-img"
                    src="${r.thumbnail}"
                    alt="${alt.replace(/"/g, "")}"
                    data-filename="${fn}"
                    loading="lazy">
            </div>
        `;
                    })
                    .join("");

                gallery.innerHTML = html;
            }

            // Randomize button click handler
            if (randomizeBtn) {
                randomizeBtn.addEventListener('click', function () {
                    if (allData) {
                        randomizeBtn.textContent = 'Loading...';
                        randomizeBtn.disabled = true;

                        setTimeout(() => {
                            loadRandomGallery(allData);
                            randomizeBtn.textContent = 'Randomize';
                            randomizeBtn.disabled = false;
                        }, 100);
                    }
                });
            }

            // Make openOverlay globally accessible
            window.openOverlay = openOverlay;

            // Load data and render
            fetch(DATA_URL)
                .then((res) => res.json())
                .then((data) => {
                    allData = data; // Store dataset globally
                    loadRandomGallery(data);
                })
                .catch((err) => console.error("Error loading data:", err));
        })();
    </script>
</body>

</html>