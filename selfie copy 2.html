<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="selfie.css">


    <title>Your Silhouette</title>

</head>

<body>




    <div id="sticky-header">
        <div id="headline">
            <a href="index.html"><img src="assets/logo.svg" alt="Headline"></a>
        </div>
    </div>
    <div>
        <a href="gallery.html" class="back-btn">
            Back to gallery
        </a>






    </div>



    <div class="wrap">
        <h1>Open Your Webcam</h1>

        <div class="controls">
            <button id="openBtn">Open camera</button>
            <button id="stopBtn" disabled>Stop</button>
            <button id="snapBtn" disabled>Capture photo</button>
            <label>
                Camera:
                <select id="deviceSelect"></select>
            </label>
        </div>

        <div class="row">
            <div>
                <video id="video" playsinline autoplay muted></video>
            </div>
            <div>
                <canvas id="canvas" width="640" height="480" hidden></canvas>
                <img id="preview" alt="Snapshot will appear here" />
                <div class="controls">
                    <a id="downloadLink" download="snapshot.png" hidden>Download sihouette</a>
                </div>
            </div>

            <!-- Add this upload button -->
            <label for="fileInput" class="upload-btn">
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </label>
        </div>

        <p class="note">
            Tip: This page must be served over <strong>HTTPS</strong> (or <code>http://localhost</code>) for the
            browser
            to allow camera access.
            On iOS/Safari, you must tap a button to start the camera.
        </p>
        <p id="error" class="error" role="alert" hidden></p>
        <p class="selfie_directions">1. Open your camera.<br>2. Place your cursor over the "capture photo" button. <br>
            3. Turn your head to the side.<br>4. Click to capture your photo.<br>5. Download your silhouette.
            <br><span style="font-style: italic;">Silhouette may take approximately one minute to process.</span>
        </p>
    </div>

    <script>
        let mClient;
        let isClientReady = false;

        // Declare all DOM elements first
        const openBtn = document.getElementById('openBtn');
        const stopBtn = document.getElementById('stopBtn');
        const snapBtn = document.getElementById('snapBtn');
        const deviceSelect = document.getElementById('deviceSelect');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const downloadLink = document.getElementById('downloadLink');
        const errorEl = document.getElementById('error');
        const fileInput = document.getElementById('fileInput');
        const ctx = canvas.getContext('2d');

        let currentStream = null;

        function showError(err) {
            console.error(err);
            errorEl.hidden = false;
            errorEl.textContent = err?.message || String(err);
        }

        function clearError() {
            errorEl.hidden = true;
            errorEl.textContent = '';
        }

        async function preload() {
            try {
                let Gradio = await import("https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js");
                mClient = await Gradio.Client.connect("arman396/Smithsonian");
                isClientReady = true;
                console.log("Gradio client loaded", Gradio, mClient);

                // Enable snap button if camera is already open
                if (currentStream && snapBtn) snapBtn.disabled = false;
            } catch (err) {
                console.error("Failed to load Gradio client:", err);
                showError(err);
            }
        }

        async function runFilter(imgBlob) {
            if (!mClient || !isClientReady) {
                throw new Error('Silhouette filter is still loading, please wait...');
            }

            let input = {
                input_image: imgBlob,
            }

            let filterRes = await mClient.predict("/predict", input);
            return filterRes.data[0].url;
        }

        async function listDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(d => d.kind === 'videoinput');
                deviceSelect.innerHTML = '';
                for (const d of videoInputs) {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.textContent = d.label || `Camera ${deviceSelect.length + 1}`;
                    deviceSelect.appendChild(opt);
                }
                if (videoInputs.length === 0) {
                    deviceSelect.innerHTML = '<option value="">No camera found</option>';
                }
            } catch (err) {
                showError(err);
            }
        }

        async function openCamera() {
            clearError();
            try {
                stopStream();

                const deviceId = deviceSelect.value || undefined;
                const constraints = {
                    video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'user' },
                    audio: false
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;

                await video.play();

                openBtn.disabled = true;
                stopBtn.disabled = false;
                snapBtn.disabled = !isClientReady; // Only enable if client is ready

                await listDevices();
            } catch (err) {
                showError(err);
            }
        }

        function stopStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            video.srcObject = null;
            openBtn.disabled = false;
            stopBtn.disabled = true;
            snapBtn.disabled = true;
        }

        async function capturePhoto() {
            if (!currentStream) return;

            const track = currentStream.getVideoTracks()[0];
            const settings = track.getSettings();
            const w = settings.width || 640;
            const h = settings.height || 480;
            canvas.width = w;
            canvas.height = h;

            ctx.drawImage(video, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/png');
            preview.src = dataUrl;

            if (!isClientReady || !mClient) {
                showError(new Error('Silhouette filter is still loading. Please wait and try again.'));
                return;
            }

            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                console.log('Captured photo blob:', blob);
                const modifiedBlob = await runFilter(blob);
                console.log('Modified blob:', modifiedBlob);
                preview.src = modifiedBlob;
                downloadLink.href = modifiedBlob;
                downloadLink.download = 'silhouette.webp';
                downloadLink.target = '_blank';
                downloadLink.hidden = false;
                downloadLink.textContent = 'Download silhouette';
                clearError();
            } catch (err) {
                showError(err);
            }
        }

        // Wire up events
        openBtn.addEventListener('click', openCamera);
        stopBtn.addEventListener('click', stopStream);
        snapBtn.addEventListener('click', capturePhoto);
        deviceSelect.addEventListener('change', () => { if (!openBtn.disabled) return; openCamera(); });

        // File upload handler
        // File upload handler
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const img = new Image();
                img.onload = async () => {
                    if (video && video.srcObject) {
                        const stream = video.srcObject;
                        stream.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }

                    const maxWidth = 640;
                    const maxHeight = 480;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Show original preview first
                    preview.src = canvas.toDataURL('image/png');

                    // Apply silhouette filter
                    if (!isClientReady || !mClient) {
                        showError(new Error('Silhouette filter is still loading. Please wait and try again.'));
                        return;
                    }

                    try {
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        console.log('Uploaded photo blob:', blob);
                        const modifiedBlob = await runFilter(blob);
                        console.log('Modified blob:', modifiedBlob);
                        preview.src = modifiedBlob;
                        downloadLink.href = modifiedBlob;
                        downloadLink.download = 'silhouette.webp';
                        downloadLink.target = '_blank';
                        downloadLink.hidden = false;
                        downloadLink.textContent = 'Download silhouette';
                        clearError();
                    } catch (err) {
                        showError(err);
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Populate device list
        if (navigator.mediaDevices?.enumerateDevices) {
            listDevices();
        }

        // Handle page unload
        window.addEventListener('beforeunload', stopStream);

        // Start loading Gradio client
        preload();
    </script>

</body>

</html>